name: Copilot Setup Steps

# Automatically run setup steps when modified, allow manual testing, and support Copilot agent calls
on:
  workflow_call:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be named `copilot-setup-steps` to be recognized by GitHub Copilot coding agent
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Set minimal permissions - Copilot will have its own token for operations
    permissions:
      contents: read

    # Environment for Copilot agent (can set secrets/variables in repository settings)
    environment: copilot

    steps:
      # Checkout repository - Copilot will use this environment state
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          # Allow enough history for git operations but limit for security
          # Note: fetch-depth will be overridden by Copilot for rollback support
          fetch-depth: 0

      # Install uv and set up Python with dependencies
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python with uv and sync deps
        run: |
          uv python install 3.11
          uv sync --dev

      # Initialize database schema for tests (uses in-memory SQLite for unit tests)
      - name: Initialize database
        run: |
          # Unit tests use in-memory SQLite, but initialize for e2e tests if needed
          uv run alembic upgrade head || echo "Database migration skipped (in-memory SQLite)"
        env:
          # Use SQLite for testing - overrides any config file
          ROUTEROS_MCP_DATABASE_URL: "sqlite+aiosqlite:///:memory:"

      # Set up encryption key to silence warnings during tests
      - name: Configure test environment
        run: |
          # Create .env file with test encryption key to avoid warnings
          echo "ROUTEROS_MCP_ENCRYPTION_KEY=dGVzdC1rZXktZm9yLWNpLWVudmlyb25tZW50LTMyLWJ5dGVz" > .env
          echo "ROUTEROS_MCP_LOG_LEVEL=WARNING" >> .env

      # Run fast smoke tests to validate environment setup
      - name: Run smoke tests
        run: |
          uv run pytest tests/smoke -q --maxfail=5
        env:
          # Ensure test mode with minimal logging
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"

      # Validate code quality - helps Copilot understand project standards
      - name: Check code formatting
        run: |
          uv run black --check routeros_mcp tests || echo "::warning::Code formatting issues detected - run 'uv run black routeros_mcp tests' to fix"
        continue-on-error: true

      # Check linting - non-blocking but provides feedback
      - name: Lint with ruff
        run: |
          uv run ruff check routeros_mcp tests || echo "::warning::Linting issues detected - run 'uv run ruff check --fix routeros_mcp tests' to auto-fix"
        continue-on-error: true

      # Type checking - helps Copilot understand type contracts
      - name: Type check with mypy
        run: |
          uv run mypy routeros_mcp || echo "::warning::Type checking issues detected - see mypy output for details"
        continue-on-error: true

      # Generate coverage report for reference (smoke-only)
      - name: Generate smoke coverage report
        run: |
          uv run pytest tests/smoke --cov=routeros_mcp --cov-report=term-missing:skip-covered -q
        continue-on-error: true

      # Display environment information for debugging
      - name: Display environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          echo "Installed packages:"
          pip list | grep -E "(fastmcp|fastapi|sqlalchemy|pytest|ruff|mypy|black)" || true
        continue-on-error: true

