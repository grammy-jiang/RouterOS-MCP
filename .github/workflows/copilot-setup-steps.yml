name: Copilot Setup Steps

# Automatically run setup steps when modified, allow manual testing, and support Copilot agent calls
on:
  workflow_call:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be named `copilot-setup-steps` to be recognized by GitHub Copilot coding agent
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    # Set minimal permissions - Copilot will have its own token for operations
    permissions:
      contents: read

    # Environment for Copilot agent (can set secrets/variables in repository settings)
    environment: copilot

    steps:
      # Checkout repository - Copilot will use this environment state
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          # Allow enough history for git operations but limit for security
          # Note: fetch-depth will be overridden by Copilot for rollback support
          fetch-depth: 0

      # Set up Python with caching for faster dependency installation
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: pyproject.toml

      # Install project dependencies in editable mode with dev extras
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      # Initialize database schema for tests (uses in-memory SQLite for unit tests)
      - name: Initialize database
        run: |
          # Unit tests use in-memory SQLite, but initialize for e2e tests if needed
          alembic upgrade head || echo "Database migration skipped (in-memory SQLite)"
        env:
          # Use SQLite for testing - overrides any config file
          ROUTEROS_MCP_DATABASE_URL: "sqlite+aiosqlite:///:memory:"

      # Set up encryption key to silence warnings during tests
      - name: Configure test environment
        run: |
          # Create .env file with test encryption key to avoid warnings
          echo "ROUTEROS_MCP_ENCRYPTION_KEY=dGVzdC1rZXktZm9yLWNpLWVudmlyb25tZW50LTMyLWJ5dGVz" > .env
          echo "ROUTEROS_MCP_LOG_LEVEL=WARNING" >> .env

      # Run fast smoke tests to validate environment setup
      - name: Run unit tests (smoke test)
        run: |
          pytest tests/unit -q --maxfail=5
        env:
          # Ensure test mode with minimal logging
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"

      # Validate code quality - helps Copilot understand project standards
      - name: Check code formatting
        run: |
          black --check routeros_mcp tests || echo "::warning::Code formatting issues detected - run 'black routeros_mcp tests' to fix"
        continue-on-error: true

      # Check linting - non-blocking but provides feedback
      - name: Lint with ruff
        run: |
          ruff check routeros_mcp tests || echo "::warning::Linting issues detected - run 'ruff check --fix routeros_mcp tests' to auto-fix"
        continue-on-error: true

      # Type checking - helps Copilot understand type contracts
      - name: Type check with mypy
        run: |
          mypy routeros_mcp || echo "::warning::Type checking issues detected - see mypy output for details"
        continue-on-error: true

      # Generate coverage report for reference
      - name: Generate coverage report
        run: |
          pytest tests/unit --cov=routeros_mcp --cov-report=term-missing:skip-covered -q
        continue-on-error: true

      # Display environment information for debugging
      - name: Display environment info
        run: |
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
          echo "Installed packages:"
          pip list | grep -E "(fastmcp|fastapi|sqlalchemy|pytest|ruff|mypy|black)" || true
        continue-on-error: true

