name: Copilot Agent CI

# Main CI pipeline for all commits and PRs (including those from Copilot agent)
# Ensures code quality gates are enforced consistently

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  # Lint and type checking job
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Use the pre-warmed environment from copilot-setup-steps
    # This ensures consistent setup and faster execution
    needs: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history to compare with base branch
      
      - name: Check if only frontend files changed
        id: check-frontend-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get list of changed files
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            # Check if all changes are in frontend/ directory
            if echo "$CHANGED_FILES" | grep -q -v '^frontend/'; then
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "Non-frontend files changed, running Python lint checks"
            else
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "Only frontend files changed, skipping Python lint checks"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Not a PR, running Python lint checks"
          fi

      - name: Install uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.11 with uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv python install 3.11
          uv sync --extra dev

      - name: Check code formatting with black
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run black --check routeros_mcp tests
        continue-on-error: true

      - name: Lint with ruff
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run ruff check routeros_mcp tests
        continue-on-error: true

      - name: Type check with mypy (core modules)
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          # Run mypy on critical stable modules; skip following imports to avoid unrelated baseline errors
          uv run mypy --no-incremental --follow-imports=skip \
            routeros_mcp/config.py routeros_mcp/main.py routeros_mcp/cli/base.py \
            routeros_mcp/infra/observability routeros_mcp/mcp \
            routeros_mcp/domain/services/firewall.py \
            routeros_mcp/domain/services/routing.py \
            routeros_mcp/domain/services/firewall_plan.py \
            routeros_mcp/domain/services/routing_plan.py \
            routeros_mcp/domain/services/wireless_plan.py \
            routeros_mcp/domain/services/device.py \
            routeros_mcp/domain/services/job.py \
            routeros_mcp/domain/services/plan.py
        continue-on-error: false
      
      - name: Skip lint for frontend-only changes
        if: steps.check-frontend-only.outputs.skip == 'true'
        run: |
          echo "✅ Skipping Python lint checks - only frontend files changed"

  # Test job with full coverage
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Use the pre-warmed environment
    needs: []

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history to compare with base branch
      
      - name: Check if only frontend files changed
        id: check-frontend-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get list of changed files
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            # Check if all changes are in frontend/ directory
            if echo "$CHANGED_FILES" | grep -q -v '^frontend/'; then
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "Non-frontend files changed, running Python tests"
            else
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "Only frontend files changed, skipping Python tests"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Not a PR, running Python tests"
          fi

      - name: Install uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }} with uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv python install ${{ matrix.python-version }}
          uv sync --extra dev

      - name: Initialize database
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          # Unit tests use in-memory SQLite and create schema via ORM
          # Skip migrations as they expect a persistent database
          echo "Database migrations skipped for in-memory SQLite (tests use ORM to create schema)"
        env:
          ROUTEROS_MCP_DATABASE_URL: "sqlite+aiosqlite:///:memory:"

      - name: Configure test environment
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          echo "ROUTEROS_MCP_ENCRYPTION_KEY=dGVzdC1rZXktZm9yLWNpLWVudmlyb25tZW50LTMyLWJ5dGVz" > .env
          echo "ROUTEROS_MCP_LOG_LEVEL=WARNING" >> .env

      - name: Run unit tests
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run pytest tests/unit -v --cov=routeros_mcp --cov-report=xml --cov-report=term-missing
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"

      - name: Run smoke tests
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run pytest tests/smoke -v --cov=routeros_mcp --cov-append || echo "No smoke tests found"
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"
        continue-on-error: true

      - name: Run e2e tests
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run pytest tests/e2e -v --cov=routeros_mcp --cov-append || echo "No e2e tests found"
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"
        continue-on-error: true

      - name: Upload coverage reports
        if: steps.check-frontend-only.outputs.skip != 'true' && matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: Combine coverage data
        if: steps.check-frontend-only.outputs.skip != 'true' && matrix.python-version == '3.11'
        run: |
          # Only combine if there are parallel coverage files
          if ls .coverage.* 1> /dev/null 2>&1; then
            uv run coverage combine
          else
            echo "No parallel coverage files found, skipping combine"
          fi

      - name: Check coverage threshold
        if: steps.check-frontend-only.outputs.skip != 'true' && matrix.python-version == '3.11'
        run: |
          uv run coverage report --fail-under=80
        continue-on-error: false
      
      - name: Skip tests for frontend-only changes
        if: steps.check-frontend-only.outputs.skip == 'true'
        run: |
          echo "✅ Skipping Python tests - only frontend files changed"

  # Security scanning job
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Fetch all history to compare with base branch
      
      - name: Check if only frontend files changed
        id: check-frontend-only
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get list of changed files
            git fetch origin ${{ github.base_ref }}
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
            
            # Check if all changes are in frontend/ directory
            if echo "$CHANGED_FILES" | grep -q -v '^frontend/'; then
              echo "skip=false" >> $GITHUB_OUTPUT
              echo "Non-frontend files changed, running security scans"
            else
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "Only frontend files changed, skipping security scans"
            fi
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Not a PR, running security scans"
          fi

      - name: Install uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.11 with uv
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv python install 3.11
          uv sync --extra dev
          uv pip install bandit[toml] safety

      - name: Run bandit security scan
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run bandit -r routeros_mcp -f json -o bandit-report.json || true
          uv run bandit -r routeros_mcp
        continue-on-error: true

      - name: Check for known vulnerabilities
        if: steps.check-frontend-only.outputs.skip != 'true'
        run: |
          uv run safety check --json || echo "::warning::Some dependencies have known vulnerabilities"
        continue-on-error: true
      
      - name: Skip security scans for frontend-only changes
        if: steps.check-frontend-only.outputs.skip == 'true'
        run: |
          echo "✅ Skipping security scans - only frontend files changed"

  # All checks must pass
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, tests, security]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint-and-typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.tests.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "::error::One or more required checks failed"
            exit 1
          fi
          echo "✅ All required checks passed!"
