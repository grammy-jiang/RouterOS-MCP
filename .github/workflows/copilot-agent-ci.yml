name: Copilot Agent CI

# Main CI pipeline for all commits and PRs (including those from Copilot agent)
# Ensures code quality gates are enforced consistently

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  # Lint and type checking job
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Use the pre-warmed environment from copilot-setup-steps
    # This ensures consistent setup and faster execution
    needs: []

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.11 with uv
        run: |
          uv python install 3.11
          uv sync --dev

      - name: Check code formatting with black
        run: |
          uv run black --check routeros_mcp tests
        continue-on-error: true

      - name: Lint with ruff
        run: |
          uv run ruff check routeros_mcp tests
        continue-on-error: true

      - name: Type check with mypy (core modules)
        run: |
          # Run mypy on critical stable modules; skip following imports to avoid unrelated baseline errors
          uv run mypy --no-incremental --follow-imports=skip \
            routeros_mcp/config.py routeros_mcp/main.py routeros_mcp/cli/base.py \
            routeros_mcp/infra/observability routeros_mcp/mcp \
            routeros_mcp/domain/services/firewall.py \
            routeros_mcp/domain/services/routing.py \
            routeros_mcp/domain/services/firewall_plan.py \
            routeros_mcp/domain/services/routing_plan.py \
            routeros_mcp/domain/services/wireless_plan.py \
            routeros_mcp/domain/services/device.py \
            routeros_mcp/domain/services/job.py \
            routeros_mcp/domain/services/plan.py
        continue-on-error: false

  # Test job with full coverage
  tests:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Use the pre-warmed environment
    needs: []

    strategy:
      matrix:
        python-version: ["3.11", "3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python ${{ matrix.python-version }} with uv
        run: |
          uv python install ${{ matrix.python-version }}
          uv sync --dev

      - name: Initialize database
        run: |
          uv run alembic upgrade head || echo "Database migration skipped (in-memory SQLite)"
        env:
          ROUTEROS_MCP_DATABASE_URL: "sqlite+aiosqlite:///:memory:"

      - name: Configure test environment
        run: |
          echo "ROUTEROS_MCP_ENCRYPTION_KEY=dGVzdC1rZXktZm9yLWNpLWVudmlyb25tZW50LTMyLWJ5dGVz" > .env
          echo "ROUTEROS_MCP_LOG_LEVEL=WARNING" >> .env

      - name: Run unit tests
        run: |
          uv run pytest tests/unit -v --cov=routeros_mcp --cov-report=xml --cov-report=term-missing
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"

      - name: Run smoke tests
        run: |
          uv run pytest tests/smoke -v || echo "No smoke tests found"
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"
        continue-on-error: true

      - name: Run e2e tests
        run: |
          uv run pytest tests/e2e -v || echo "No e2e tests found"
        env:
          ROUTEROS_MCP_DEBUG: "false"
          ROUTEROS_MCP_LOG_LEVEL: "WARNING"
        continue-on-error: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: Check coverage threshold
        if: matrix.python-version == '3.11'
        run: |
          coverage report --fail-under=80
        continue-on-error: false

  # Security scanning job
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python 3.11 with uv
        run: |
          uv python install 3.11
          uv sync --dev
          uv pip install bandit[toml] safety

      - name: Run bandit security scan
        run: |
          uv run bandit -r routeros_mcp -f json -o bandit-report.json || true
          uv run bandit -r routeros_mcp
        continue-on-error: true

      - name: Check for known vulnerabilities
        run: |
          uv run safety check --json || echo "::warning::Some dependencies have known vulnerabilities"
        continue-on-error: true

  # All checks must pass
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, tests, security]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint-and-typecheck.result }}" != "success" ]] || \
             [[ "${{ needs.tests.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]]; then
            echo "::error::One or more required checks failed"
            exit 1
          fi
          echo "âœ… All required checks passed!"
